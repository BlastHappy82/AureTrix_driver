import type {
  // IDKSMode,
  // IEndMode,
  // IMacroMode,
  // IMPTMode,
  // IMTMode,
  // ISOCDMode,
  // ISOCDModeV2,
  // ISOCDModeV3,
  // ITGLMode,
  LightModeType,
} from '@sparklinkplayjoy/protocol-keyboard';

// import type { MacroType } from '../types/type';
import { isArray, isObject } from './index';

// type ISOCDModeType = ISOCDMode | ISOCDModeV2 | ISOCDModeV3;
// 定义类型接口

interface LightConfig {
  open: boolean;
  mode: LightModeType;
  staticColors: string[];
  selectStaticColor: number;
  luminance: number;
  speed: number;
  sleepTime: number;
  direction: boolean;
  dynamic: number;
}

interface PerformanceConfig {
  isGlobalTriggering: boolean;
  globalTriggeringValue: number;
  isRt: boolean;
  isSingle: boolean;
  singleTriggeringValue: number;
  rtPressValue: number;
  rtReleaseValue: number;
  axisID: number;
  deadBandPressValue: number;
  deadBandReleaseValue: number;
  advancedKeyMode: number;
}

interface AdvancedKeyConfig {
  advancedType?: string;
  value?: number;
  // dks?: IDKSMode;
  // mpt?: IMPTMode;
  // mt?: IMTMode;
  // tgl?: ITGLMode;
  // end?: IEndMode;
  // socd?: ISOCDModeType;
  // macro?: IMacroMode & { macros: MacroType[] };
  dks?: any;
  mpt?: any;
  mt?: any;
  tgl?: any;
  end?: any;
  socd?: any;
  macro?: any;
}

interface CustomKeyConfig {
  fn0: { keyValue: number; bindKeyValue: number } | null;
  fn1: { keyValue: number; bindKeyValue: number } | null;
  fn2: { keyValue: number; bindKeyValue: number } | null;
  fn3: { keyValue: number; bindKeyValue: number } | null;
}

interface KeyboardLightConfig {
  custom: {
    R: number;
    G: number;
    B: number;
    key: number;
  };
}

export interface Keyboards {
  col: number;
  row: number;
  keyValue: number;
  performance: PerformanceConfig;
  advancedKeys: AdvancedKeyConfig;
  customKeys: CustomKeyConfig;
  light: KeyboardLightConfig;
}

export interface KeyboardConfig {
  light: {
    main: LightConfig;
    logo: LightConfig;
    other: LightConfig;
  };
  keyboards: Array<Keyboards>;
  macro: {
    list: Array<{
      date: string;
      id: number;
      name: string;
      step: Array<{
        id: number;
        keyValue: number;
        status: number;
        delay: number;
      }>;
    }>;
    v2list: any[];
  };
  system: {
    rateOfReturn: number;
    topDeadBandSwitch: number;
    productId: number;
    vendorId: number;
    keyboardName: string;
    usage: number;
    usagePage: number;
  };
  other?: any;
  version?: string;
  firmwareVersion?: string;
  protocolVersion?: string;
}
export interface ImportResult {
  success: boolean;
  error?: string;
}

export class ConfigValidator {
  private static validateLightConfig(config: LightConfig): string | null {
    if (typeof config.open !== 'boolean') return 'light.open must be boolean';
    if (typeof config.mode !== 'string') return 'light.mode must be string';
    if (!isArray(config.staticColors)) return 'light.staticColors must be array';
    if (typeof config.luminance !== 'number' || config.luminance < 0 || config.luminance > 100) {
      return 'light.luminance must be number between 0 and 100';
    }
    // 验证自定义数据
    if (config.custom && isArray(config.custom.data)) {
      for (const item of config.custom.data) {
        if (typeof item.key !== 'number' || typeof item.x !== 'number' || typeof item.y !== 'number') {
          return 'Invalid custom light data format';
        }
        if (!isArray(item.color)) return 'light.custom.data.color must be array';
      }
    }
    return null;
  }

  private static validatePerformance(performance: PerformanceConfig): string | null {
    const checks: { key: keyof PerformanceConfig; type: string | string[] }[] = [
      { key: 'isGlobalTriggering', type: 'boolean' },
      { key: 'globalTriggeringValue', type: 'number' },
      { key: 'isRt', type: 'boolean' },
      { key: 'isSingle', type: 'boolean' },
      { key: 'singleTriggeringValue', type: ['string', 'number'] },
      { key: 'rtPressValue', type: 'number' },
      { key: 'rtReleaseValue', type: 'number' },
      { key: 'axisID', type: 'number' },
      { key: 'deadBandPressValue', type: 'number' },
      { key: 'deadBandReleaseValue', type: 'number' },
    ];

    for (const { key, type } of checks) {
      // eslint-disable-next-line valid-typeof
      if (Array.isArray(type)) {
        if (!type.includes(typeof performance[key])) {
          console.log('performance[key]', performance[key], key, type);
          return `performance.${key} must be ${type[0]}`;
        }
      } else if (typeof performance[key] !== type) {
        console.log('performance[key]', performance[key], key, type);
        return `performance.${key} must be ${type}`;
      }
    }

    return null;
  }

  private static validateAdvancedKey(advancedKeys: AdvancedKeyConfig): string | null {
    if (Object.keys(advancedKeys).length === 0) return null;
    console.log('advancedKeys.advancedType', advancedKeys.advancedType, advancedKeys);
    if (typeof advancedKeys.advancedType !== 'string' && typeof advancedKeys.advancedType !== 'number')
      return 'advancedKeys.advancedType must be string or number';
    if (typeof advancedKeys.value !== 'number') return 'advancedKeys.value must be number';
    const optionalFields = ['dks', 'mpt', 'mt', 'tgl', 'end', 'socd', 'macro'];

    for (const field of optionalFields) {
      const value = advancedKeys[field as keyof AdvancedKeyConfig];
      if (value !== undefined && typeof value !== 'object') {
        return `${field} must be an object if defined`;
      }
    }

    return null;
  }

  private static validateCustomKey(customKeys: CustomKeyConfig): string | null {
    const fnLsit = ['fn0', 'fn1', 'fn2', 'fn3'];

    for (const key of fnLsit) {
      const value = customKeys[key as keyof CustomKeyConfig];

      if (value !== null) {
        if (typeof value !== 'object') {
          return `${key} must be an object or null`;
        }
        if (typeof value.keyValue !== 'number') {
          return `${key}.keyValue must be a number`;
        }
        if (typeof value.bindKeyValue !== 'number') {
          return `${key}.bindKeyValue must be a number`;
        }
      }
    }
    return null;
  }

  private static validateKeyboards(keyboards: Array<Keyboards>): string | null {
    if (!isArray(keyboards)) return 'keyboards must be array';
    for (const item of keyboards) {
      // console.log('item: ', item.col, item);
      const { col, row, keyValue, performance, advancedKeys, customKeys } = item;
      if (typeof col !== 'number') return 'keyboards.col must be number';
      if (typeof row !== 'number') return 'keyboards.row must be number';
      if (typeof keyValue !== 'number') return 'keyboards.keyValue must be number';
      if (!isObject(performance)) return 'keyboards.performance must be object';
      if (!isObject(advancedKeys)) return 'keyboards.advancedKeys must be object';
      if (!isObject(customKeys)) return 'keyboards.customKeys must be object';
      const performanceError = this.validatePerformance(performance);
      if (performanceError) return performanceError;
      const advancedKeyError = this.validateAdvancedKey(advancedKeys);
      if (advancedKeyError) return advancedKeyError;
      const customKeyError = this.validateCustomKey(customKeys);
      if (customKeyError) return customKeyError;
    }
    return null;
  }

  // private static validateMacro(macro: KeyboardConfig['macro']): string | null {
  //   if (!isArray(macro.list)) return 'macro.list must be array';

  //   for (const item of macro.list) {
  //     if (!item.date || !item.id || !item.name || !isArray(item.step)) {
  //       return 'Invalid macro format';
  //     }
  //   }
  //   return null;
  // }

  static validateConfig(config: KeyboardConfig): { isValid: boolean; error?: string } {
    try {
      // 验证光效配置
      const lightError = this.validateLightConfig(config.light.main) || this.validateLightConfig(config.light.logo);
      if (lightError) return { isValid: false, error: lightError };

      // 验证性能、高级键和自定义按键配置
      const keyboardError = this.validateKeyboards(config.keyboards);
      console.log('config.keyboards: ', config.keyboards);
      if (keyboardError) return { isValid: false, error: keyboardError };

      // // TODO 暂不验证
      // // 验证宏配置
      // const macroError = this.validateMacro(config.macro);
      // if (macroError) return { isValid: false, error: macroError };

      // // 验证版本信息
      // if (!config.version || !config.firmwareVersion || !config.protocolVersion) {
      //   return { isValid: false, error: 'Missing version information' };
      // }

      // 验证系统配置
      if (typeof config.system.rateOfReturn !== 'number' || typeof config.system.topDeadBandSwitch !== 'number') {
        return { isValid: false, error: 'Invalid system configuration' };
      }

      return { isValid: true };
    } catch (error) {
      return {
        isValid: false,
        error: `Validation failed: ${error.message}`,
      };
    }
  }
}
